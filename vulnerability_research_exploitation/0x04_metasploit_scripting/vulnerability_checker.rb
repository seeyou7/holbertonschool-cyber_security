require 'msf/core'

class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::Tcp

  def initialize(info = {})
    super(update_info(info,
      'Name'        => 'Simple MS17-010 Vulnerability Checker',
      'Description' => %q{
        A simple module to check if a target system is vulnerable to MS17-010 (EternalBlue).
      },
      'Author'      => [ 'idoudi2020' ],
      'License'     => MSF_LICENSE
    ))

    register_options([
      Opt::RHOST(),
      Opt::RPORT(445)
    ])
  end

  def run
    rhost = datastore['RHOST']
    print_status("Checking #{rhost} for MS17-010 vulnerability")

    begin
      connect
      sock.put(simple_smb_request)
      response = sock.get_once

      if response && response.include?("SMB")
        print_good("#{rhost} is vulnerable to MS17-010.")
      else
        print_error("#{rhost} is not vulnerable or check failed.")
      end
    rescue => e
      print_error("Error: #{e.message}")
    ensure
      disconnect
    end
  end

  def simple_smb_request
    "\x00\x00\x00\x90\xffSMB" + "\x00" * 128
  end
end

